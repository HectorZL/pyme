{% extends 'base.html' %}
{% load static %}
{% load anime_filters %}

{% block title %}Mi Lista de Anime - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user_anime_list.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Mi Lista de Anime</h1>
        <div class="btn-group">
            <a href="{% url 'anime:catalog' %}" class="btn btn-outline-primary">
                <i class="fas fa-plus me-1"></i> Añadir más animes
            </a>
        </div>
    </div>
    
    <!-- Status Tabs -->
    <ul class="nav nav-tabs mb-4" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_status == 'por_ver' or not active_status %}active{% endif %}" 
                    id="porver-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#porver" 
                    type="button" 
                    role="tab" 
                    aria-controls="porver" 
                    aria-selected="{% if active_status == 'por_ver' or not active_status %}true{% else %}false{% endif %}">
                <i class="fas fa-bookmark me-1"></i> Por ver
                <span class="badge bg-secondary ms-1">{{ status_counts.por_ver|default:0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_status == 'viendo' %}active{% endif %}" 
                    id="viendo-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#viendo" 
                    type="button" 
                    role="tab" 
                    aria-controls="viendo" 
                    aria-selected="{% if active_status == 'viendo' %}true{% else %}false{% endif %}">
                <i class="fas fa-tv me-1"></i> Viendo
                <span class="badge bg-primary ms-1">{{ status_counts.viendo|default:0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_status == 'finalizado' %}active{% endif %}" 
                    id="finalizado-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#finalizado" 
                    type="button" 
                    role="tab" 
                    aria-controls="finalizado" 
                    aria-selected="{% if active_status == 'finalizado' %}true{% else %}false{% endif %}">
                <i class="fas fa-check-circle me-1"></i> Finalizado
                <span class="badge bg-success ms-1">{{ status_counts.finalizado|default:0 }}</span>
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="animeListContent">
        <!-- Por Ver Tab -->
        <div class="tab-pane fade {% if active_status == 'por_ver' or not active_status %}show active{% endif %}" 
             id="porver" role="tabpanel" aria-labelledby="porver-tab">
            {% with por_ver_list=user_anime_list|filter_by_status:'por_ver' %}
                {% if por_ver_list %}
                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
                        {% for item in por_ver_list %}
                            {% with anime=item.anime %}
                                {% include 'anime/partials/anime_card.html' with status=item.status %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-bookmark fa-4x text-muted mb-3"></i>
                        <h3 class="h4">No tienes animes por ver</h3>
                        <p class="text-muted">Añade animes a tu lista para verlos aquí.</p>
                        <a href="{% url 'anime:catalog' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-search me-1"></i> Explorar Catálogo
                        </a>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- Viendo Tab -->
        <div class="tab-pane fade {% if active_status == 'viendo' %}show active{% endif %}" 
             id="viendo" role="tabpanel" aria-labelledby="viendo-tab">
            {% with viendo_list=user_anime_list|filter_by_status:'viendo' %}
                {% if viendo_list %}
                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
                        {% for item in viendo_list %}
                            {% with anime=item.anime %}
                                {% include 'anime/partials/anime_card.html' with status=item.status %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-tv fa-4x text-muted mb-3"></i>
                        <h3 class="h4">No estás viendo ningún anime</h3>
                        <p class="text-muted">Añade animes a tu lista y márcalos como 'Viendo' para verlos aquí.</p>
                        <a href="{% url 'anime:catalog' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-search me-1"></i> Explorar Catálogo
                        </a>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- Finalizado Tab -->
        <div class="tab-pane fade {% if active_status == 'finalizado' %}show active{% endif %}" 
             id="finalizado" role="tabpanel" aria-labelledby="finalizado-tab">
            {% with finalizado_list=user_anime_list|filter_by_status:'finalizado' %}
                {% if finalizado_list %}
                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
                        {% for item in finalizado_list %}
                            {% with anime=item.anime %}
                                {% include 'anime/partials/anime_card.html' with status=item.status %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-4x text-muted mb-3"></i>
                        <h3 class="h4">No has completado ningún anime</h3>
                        <p class="text-muted">Marca los animes como 'Finalizado' para verlos aquí.</p>
                        <a href="{% url 'anime:catalog' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-search me-1"></i> Explorar Catálogo
                        </a>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
</div>

<!-- Modal for adding/updating anime status -->
<div class="modal fade" id="animeStatusModal" tabindex="-1" aria-labelledby="animeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="animeStatusModalLabel">Actualizar estado del anime</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="animeStatusForm">
                <div class="modal-body">
                    <input type="hidden" id="animeId" name="anime_id">
                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusPorVer" value="por_ver" checked>
                            <label class="form-check-label" for="statusPorVer">
                                <i class="fas fa-bookmark text-secondary me-1"></i> Por ver
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusViendo" value="viendo">
                            <label class="form-check-label" for="statusViendo">
                                <i class="fas fa-tv text-primary me-1"></i> Viendo
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusFinalizado" value="finalizado">
                            <label class="form-check-label" for="statusFinalizado">
                                <i class="fas fa-check-circle text-success me-1"></i> Finalizado
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="score" class="form-label">Puntuación (opcional)</label>
                        <select class="form-select" id="score" name="score">
                            <option value="">Sin puntuación</option>
                            <option value="10">(10) Excelente</option>
                            <option value="9">(9) Muy bueno</option>
                            <option value="8">(8) Bueno</option>
                            <option value="7">(7) Por encima del promedio</option>
                            <option value="6">(6) Aceptable</option>
                            <option value="5">(5) Promedio</option>
                            <option value="4">(4) Por debajo del promedio</option>
                            <option value="3">(3) Malo</option>
                            <option value="2">(2) Muy malo</option>
                            <option value="1">(1) Pésimo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="progress" class="form-label">Episodios vistos</label>
                        <input type="number" class="form-control" id="progress" name="progress" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrfToken = getCookie('csrftoken');

// Initialize modal
const animeStatusModal = new bootstrap.Modal(document.getElementById('animeStatusModal'));
let currentAnimeId = null;
let currentAnimeTitle = '';

// Function to open modal with anime data
function openAnimeStatusModal(animeId, animeTitle, currentStatus = 'por_ver', currentScore = '', progress = 0) {
    currentAnimeId = animeId;
    currentAnimeTitle = animeTitle;
    document.getElementById('animeId').value = animeId;
    
    // Set the current status
    document.querySelector(`input[name="status"][value="${currentStatus}"]`).checked = true;
    
    // Set the current score if exists
    if (currentScore) {
        document.getElementById('score').value = currentScore;
    } else {
        document.getElementById('score').value = '';
    }
    
    // Set the current progress
    document.getElementById('progress').value = progress;
    
    // Show the modal
    animeStatusModal.show();
}

// Function to update favorite status
function toggleFavorite(animeId, animeTitle, isFavorite) {
    fetch(`/anime/${animeId}/toggle_favorite/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            is_favorite: !isFavorite
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const favoriteBtn = document.querySelector(`.favorite-btn[data-anime-id="${animeId}"]`);
            if (favoriteBtn) {
                favoriteBtn.classList.toggle('active', data.is_favorite);
                favoriteBtn.setAttribute('data-is-favorite', data.is_favorite);
                
                // Show notification
                const action = data.is_favorite ? 'añadido a' : 'eliminado de';
                showNotification('success', `"${animeTitle}" ${action} tus favoritos`);
            }
        } else {
            showNotification('error', 'Error al actualizar favoritos');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'Error al actualizar favoritos');
    });
}

// Handle form submission
document.getElementById('animeStatusForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const animeId = document.getElementById('animeId').value;
    const status = document.querySelector('input[name="status"]:checked').value;
    const score = document.getElementById('score').value;
    const progress = document.getElementById('progress').value;
    
    // Map status to display text
    const statusTexts = {
        'por_ver': 'Por ver',
        'viendo': 'Viendo',
        'finalizado': 'Finalizado'
    };
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
    
    // Send data to server
    fetch(`/anime/${animeId}/update_status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `status=${status}&score=${score}&progress=${progress}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close the modal
            animeStatusModal.hide();
            
            // Show success notification
            showNotification('success', `"${currentAnimeTitle}" actualizado a "${statusTexts[status] || status}"`);
            
            // Reload the page to show updated data after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al actualizar el estado del anime');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', error.message || 'Error al actualizar el estado del anime');
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
});

// Add click handlers for all favorite buttons
document.addEventListener('DOMContentLoaded', function() {
    // Handle favorite button clicks
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const animeId = this.getAttribute('data-anime-id');
            const animeTitle = this.getAttribute('data-anime-title') || 'Este anime';
            const isFavorite = this.getAttribute('data-is-favorite') === 'true';
            
            toggleFavorite(animeId, animeTitle, isFavorite);
        });
    });
    
    // Handle anime card clicks to open status modal
    document.querySelectorAll('.anime-card').forEach(card => {
        card.addEventListener('click', function() {
            const animeId = this.getAttribute('data-anime-id');
            const animeTitle = this.getAttribute('data-anime-title');
            const currentStatus = this.getAttribute('data-status') || 'por_ver';
            const currentScore = this.getAttribute('data-score') || '';
            const currentProgress = this.getAttribute('data-progress') || '0';
            
            openAnimeStatusModal(animeId, animeTitle, currentStatus, currentScore, currentProgress);
        });
    });
    
    // Show notification if there's a success message in the URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('status_updated')) {
        showNotification('success', 'Estado del anime actualizado correctamente');
        // Clean the URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// Function to show toast notifications
function showNotification(type, message) {
    const toast = document.createElement('div');
    toast.classList.add('toast', `toast-${type}`);
    toast.innerHTML = `
        <div class="toast-header">
            <strong class="me-auto">${type === 'success' ? 'Éxito' : 'Error'}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    document.body.appendChild(toast);
    const toastElement = new bootstrap.Toast(toast);
    toastElement.show();
}
</script>
{% endblock %}
